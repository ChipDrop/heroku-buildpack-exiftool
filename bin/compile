#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

arrow() {
  sed -u 's/^/-----> /'
}

indent() {
  sed -u 's/^/       /'
}

# extract url of latest production version from the rss feed
RSSFEED_URL="http://owl.phy.queensu.ca/~phil/exiftool/rss.xml"
TARBALL_URL="$(curl -s -o - "$RSSFEED_URL" | perl -ne 'if (!$got && (/\<title\>.+production release.+\<\/title\>/i .. /\<\/item\>/) && /enclosure.+(http.+\.tar\.gz)/) {print $1; $got = 1}')"
RENAME_DIR="$(echo "$TARBALL_URL" | perl -ne '/.+\/(.+)\.tar\.gz/ && print $1')"
VERSION_NO="$(echo "$RENAME_DIR"  | perl -ne '/ExifTool-(.+)$/i   && print $1')"
TARGET_PATH="$1/vendor"
VENDOR_PATH="/app/vendor"

echo "Installing exiftool" | arrow

# download and unpack
mkdir -p "$TARGET_PATH"
cd       "$TARGET_PATH"
curl --fail --retry 3 --retry-delay 1 --connect-timeout 3 "$TARBALL_URL" -s -o - | tar zxf -

# configure path
cat <<EOF > "$1/.profile.d/exiftool.sh"
export PATH="$VENDOR_PATH/exiftool:\$PATH"
EOF

# show installed version
mv "$RENAME_DIR" exiftool
cd             ./exiftool
echo "Version: $VERSION_NO"  | indent
echo "Installed: "`ls exif*` | indent
echo
